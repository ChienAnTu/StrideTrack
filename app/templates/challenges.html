{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<div class="bg-white">
  <div class="mx-auto grid max-w-2xl grid-cols-1 items-center gap-x-8 gap-y-16 px-4 py-24 sm:px-6 sm:py-32 lg:max-w-7xl lg:grid-cols-2 lg:px-8">
    <!-- Modified Sidebar -->
    <div class="space-y-8">
      <h2 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">Trail Explorer</h2>
      <p class="mt-4 text-gray-500">Select a trail to view its route and details.</p>

      <!-- Trail Selection Cards -->
      <div class="space-y-4">
        <div class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 trail-card" data-trail="greenMount">
          <h3 class="font-medium text-lg text-gray-900">Green Mountain Trail</h3>
          <p class="text-sm text-gray-500">Distance: 5.2km | Difficulty: Moderate</p>
        </div>
        
        <div class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 trail-card" data-trail="kingsPark">
          <h3 class="font-medium text-lg text-gray-900">Kings Park</h3>
          <p class="text-sm text-gray-500">Distance: 8.1km | Difficulty: Hard</p>
        </div>
        
        <div class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 trail-card" data-trail="hydePark">
          <h3 class="font-medium text-lg text-gray-900">Hyde Park</h3>
          <p class="text-sm text-gray-500">Distance: 3.7km | Difficulty: Easy</p>
        </div>
      </div>

      <!-- Trail Details (Dynamic) -->
      <div id="trail-details" class="mt-8 hidden">
        <h3 class="font-medium text-xl text-gray-900" id="trail-name">Trail Name</h3>
        <dl class="mt-4 grid grid-cols-2 gap-4">
          <div class="border-t border-gray-200 pt-2">
            <dt class="text-sm font-medium text-gray-500">Distance</dt>
            <dd class="mt-1 text-sm text-gray-900" id="trail-distance">--</dd>
          </div>
          <div class="border-t border-gray-200 pt-2">
            <dt class="text-sm font-medium text-gray-500">Elevation</dt>
            <dd class="mt-1 text-sm text-gray-900" id="trail-elevation">--</dd>
          </div>
          <div class="border-t border-gray-200 pt-2">
            <dt class="text-sm font-medium text-gray-500">Difficulty</dt>
            <dd class="mt-1 text-sm text-gray-900" id="trail-difficulty">--</dd>
          </div>
          <div class="border-t border-gray-200 pt-2">
            <dt class="text-sm font-medium text-gray-500">Duration</dt>
            <dd class="mt-1 text-sm text-gray-900" id="trail-duration">--</dd>
          </div>
        </dl>
        <p class="mt-4 text-sm text-gray-500" id="trail-description"></p>
      </div>
    </div>

    <!-- Map Container -->
    <div class="w-full h-[600px]">
      <div id="map" class="w-full h-full rounded-lg shadow-lg"></div>
    </div>
  </div>
</div>

<script>
  // Initialize map with default view
  const map = L.map('map').setView([-31.90988, 116.062805], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data Â© OpenStreetMap contributors'
  }).addTo(map);

  // Trail data (could also fetch this from an API)
  const trails = {
    greenMount: {
      name: "Green Mountain Trail",
      gpx: "static/trails/greenMount.gpx",
      color: "#10B981",
      distance: "5.2 km",
      elevation: "320 m",
      difficulty: "Moderate",
      duration: "2-3 hours",
      description: "Scenic trail through dense forest with panoramic views at the summit."
    },
    kingsPark: {
      name: "Kings Park",
      gpx: "static/trails/kingsPark.gpx",
      color: "#3B82F6",
      distance: "8.1 km",
      elevation: "450 m",
      difficulty: "Hard",
      duration: "3-4 hours",
      description: "Challenging ridge walk with steep sections and exposed areas."
    },
    hydePark: {
      name: "hydePark",
      gpx: "static/trails/hydePark.gpx",
      color: "#F59E0B",
      distance: "3.7 km",
      elevation: "120 m",
      difficulty: "Easy",
      duration: "1-1.5 hours",
      description: "Gentle loop through wildflower meadows, perfect for families."
    }
  };

  // Current active trail layer
  let activeTrailLayer = null;

  // Function to load and display a trail
  function loadTrail(trailId) {
    const trail = trails[trailId];
    
    // Remove previous trail if exists
    if (activeTrailLayer) {
      map.removeLayer(activeTrailLayer);
    }

    // Update sidebar details
    document.getElementById('trail-name').textContent = trail.name;
    document.getElementById('trail-distance').textContent = trail.distance;
    document.getElementById('trail-elevation').textContent = trail.elevation;
    document.getElementById('trail-difficulty').textContent = trail.difficulty;
    document.getElementById('trail-duration').textContent = trail.duration;
    document.getElementById('trail-description').textContent = trail.description;
    document.getElementById('trail-details').classList.remove('hidden');

    // Highlight selected trail card
    document.querySelectorAll('.trail-card').forEach(card => {
      card.classList.remove('bg-green-50', 'border-green-200');
    });
    document.querySelector(`.trail-card[data-trail="${trailId}"]`).classList.add('bg-green-50', 'border-green-200');

    // Load GPX file
    fetch(trail.gpx)
      .then(res => res.text())
      .then(gpxText => {
        activeTrailLayer = new L.GPX(gpxText, {
          async: true,
          polyline_options: {
            color: trail.color,
            weight: 5,
            opacity: 0.8
          },
          marker_options: {
            startIcon: L.divIcon({
              html: 'ðŸ',
              className: 'gpx-marker',
              iconSize: [30, 30]
            }),
            endIcon: L.divIcon({
              html: 'ðŸ“',
              className: 'gpx-marker',
              iconSize: [30, 30]
            }),
            shadowUrl: null
          }
        }).on('loaded', function(e) {
          map.fitBounds(e.target.getBounds());
          // You could add elevation chart or other features here
        }).addTo(map);
      })
      .catch(err => console.error('Error loading trail:', err));
  }

  // Set up click handlers for trail cards
  document.querySelectorAll('.trail-card').forEach(card => {
    card.addEventListener('click', () => {
      loadTrail(card.dataset.trail);
    });
  });

  // Load first trail by default
  loadTrail('greenMount');
</script>

<style>
  .trail-card {
    transition: all 0.2s ease;
  }
  .gpx-marker {
    text-align: center;
    font-size: 20px;
    line-height: 30px;
  }
</style>

{% endblock %}